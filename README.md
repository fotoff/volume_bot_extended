# Extended Trading Bot v2 - X10 Starknet

Продвинутый торговый бот для биржи X10 на сети Starknet с многоветочной стратегией и алгоритмом "покупка на росте".

## 🚀 Возможности

- **Стратегия "Покупка на росте"**: Автоматическое размещение ордеров при росте цены на заданный процент
- **Многоветочная система**: Каждая покупка создает независимую ветку с собственными SELL ордерами и стоп-лоссом
- **Лесенка продаж**: Автоматическое размещение 3 SELL ордеров на разных уровнях прибыли
- **Адаптивный стоп-лосс**: Защита от потерь для каждой отдельной ветки
- **Торговля несколькими парами**: Поддержка одновременной торговли множественными парами
- **Сохранение состояния**: Восстановление состояния между перезапусками
- **Переразмещение ордеров**: Автоматическое переразмещение неисполненных ордеров ближе к рынку
- **Отслеживание позиций**: Мониторинг расхождений и детекция ошибок в реальном времени
- **Управление TTL**: Обработка времени жизни buy ордеров

## 📊 Поддерживаемые торговые пары

| Пара | Триггер роста | Уровни продажи | Примечания |
|------|-------------|-------------|--------|
| **BTC-USD** | 0.3% | [0.3%, 0.6%, 0.9%] | Основная пара |
| **ETH-USD** | 0.4% | [0.4%, 0.8%, 1.2%] | Крупный альткоин |
| **SOL-USD** | 0.5% | [0.5%, 1.0%, 1.5%] | Высокая волатильность |
| **OP-USD** | 0.6% | [0.6%, 1.2%, 1.8%] | Layer 2 токен |
| **HYPE-USD** | 0.3% | [0.2%, 0.4%, 0.6%] | Оптимизированные настройки |
| **DOGE-USD** | 0.8% | [0.8%, 1.6%, 2.4%] | Мем-коин |

## 🏗️ Архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Мониторинг цены │───▶│ Трекер якоря    │───▶│ Триггер покупки │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                         │
                                                         ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Стоп-лосс     │◀───│ Менеджер веток  │◀───│ Размещение      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │ Менеджер        │
                       │ состояния       │
                       └─────────────────┘
```

## 🔧 Установка

### Системные требования

- Python 3.8+
- Доступ к API X10 Starknet
- Linux/macOS окружение (рекомендуется)

### Настройка окружения

1. **Клонирование репозитория:**
```bash
git clone https://github.com/fotoff/volume_bot_extended.git
cd volume_bot_extended
```

2. **Создание виртуального окружения:**
```bash
python3 -m venv bot-env
source bot-env/bin/activate  # Linux/macOS
# или bot-env\Scripts\activate  # Windows
```

3. **Установка зависимостей:**
```bash
pip install -r requirements.txt
```

4. **Настройка переменных окружения:**
```bash
cp env.example .env
# Отредактируйте .env файл с вашими API ключами
```

### Переменные окружения

Создайте файл `.env` со следующими переменными:

```env
EXTENDED_API_KEY=ваш_api_ключ
EXTENDED_PUBLIC_KEY=ваш_публичный_ключ
EXTENDED_STARK_PRIVATE=ваш_приватный_ключ
EXTENDED_VAULT_ID=ваш_vault_id
BOT_STATE_FILE=bot_state.json
```

## ⚙️ Конфигурация

### Основная конфигурация (`config.py`)

Ключевые параметры для настройки:

- **`MARKETS`**: Активные торговые пары
- **`BUY_QTY`**: Размер покупки для каждой пары
- **`BUY6_STEP_PCT`**: Процент роста для триггера покупок
- **`SELL_STEPS_PCT`**: Уровни прибыли для продаж
- **`BRANCH_SL_PCT`**: Процент стоп-лосса для каждой ветки
- **`BUY_TTL_SECONDS`**: Время жизни buy ордеров (по умолчанию: 300с)

### Пример конфигурации

```python
MARKETS = ["BTC-USD", "HYPE-USD"]

BUY_QTY = {
    "BTC-USD": 0.0004,   # 0.0004 BTC за сделку
    "HYPE-USD": 1.0,     # 1.0 HYPE за сделку
}

BUY6_STEP_PCT = {
    "BTC-USD": 0.003,    # 0.3% триггер роста
    "HYPE-USD": 0.003,   # 0.3% триггер роста
}
```

## 🚀 Запуск бота

### Локальная разработка

```bash
source bot-env/bin/activate
python extended-bot-v2.py
```

### Продакшн развертывание (systemd)

1. **Создание service файла:**
```bash
sudo cp extended-bot-rise.service /etc/systemd/system/
sudo systemctl daemon-reload
```

2. **Включение и запуск сервиса:**
```bash
sudo systemctl enable extended-bot-rise
sudo systemctl start extended-bot-rise
```

3. **Мониторинг статуса:**
```bash
systemctl status extended-bot-rise
journalctl -u extended-bot-rise -f
```

## 📈 Торговая стратегия

### Алгоритм покупки

1. **Отслеживание якоря**: Бот отслеживает минимальную цену (якорь) для каждой пары
2. **Детекция роста**: При росте цены на заданный процент от якоря
3. **Размещение ордера**: Размещает лимитный BUY ордер по текущему bid
4. **Создание ветки**: После исполнения создает новую независимую ветку

### Управление ветками

Каждая ветка работает независимо с:
- **Уникальным ID**: Последовательная нумерация по символу
- **Ценой и размером покупки**: Детали оригинальной покупки
- **WAP (Средневзвешенная цена)**: Для множественных исполнений
- **Стоп-лоссом**: Индивидуальный уровень защиты
- **Лесенкой продаж**: 3 SELL ордера на разных уровнях прибыли

### Управление ордерами

- **Защита TTL**: Buy ордера автоматически переразмещаются при истечении
- **Обработка частичных исполнений**: Остаток переразмещается ближе к рынку
- **Дедупликация**: Предотвращает множественные SELL ордера на leg
- **Сверка позиций**: Автоматическая детекция расхождений и логирование

## 🔍 Мониторинг и логирование

### Категории логов

| Иконка | Тип | Описание |
|------|------|-------------|
| 📈 | Цена | Мониторинг цены и обновления якоря |
| 🟢 | Покупка | Размещение buy ордеров |
| 🆕 | Ветка | Создание новой ветки |
| 🟠 | Продажа | Размещение sell ордеров |
| 🛑 | Стоп-лосс | Исполнение стоп-лосса |
| ⚠️ | Предупреждение | Расхождения позиций |
| 🔄 | Состояние | Изменения состояния веток |

### Пример вывода логов

```
[BTC-USD] 📈 last=112593 | pos=0 WAP=0 | branches=0
[BTC-USD] 🎯 Устанавливаем якорь на минимум: 112587
[HYPE-USD] 🟢 BUY размещён 1.0@41.9; anchor→41.888
[HYPE-USD] 🆕 Ветка 1: buy=41.9, size=1.00, SL=41.1
[HYPE-USD] 🟠 SELL L1 ветки 1 0.3@42.0
```

### Управление состоянием

Бот поддерживает постоянное состояние в `bot_state.json`:
- Информация о ветках и временные метки
- Цены якорей для каждого символа
- Счетчики следующих ID веток

## 🔧 Команды управления

### Управление сервисом

```bash
# Проверка статуса
systemctl status extended-bot-rise

# Просмотр логов
journalctl -u extended-bot-rise -f
journalctl -u extended-bot-rise --lines=50

# Управление сервисом
systemctl start extended-bot-rise
systemctl stop extended-bot-rise
systemctl restart extended-bot-rise
```

### Ручные операции

```bash
# Очистка состояния (свежий старт)
rm bot_state.json

# Проверка конфигурации
python -c "from config import *; print(f'Markets: {MARKETS}')"

# Валидация окружения
python -c "from dotenv import load_dotenv; import os; load_dotenv(); print('API Key:', os.getenv('EXTENDED_API_KEY')[:10] + '...')"
```

## 🔧 Устранение неполадок

### Частые проблемы

1. **Расхождение позиций**
   - Симптом: `⚠️ РАСХОЖДЕНИЕ: ветки=X, позиция=Y`
   - Причина: Сброс состояния при существующей позиции
   - Решение: Бот автоматически детектирует и логирует, рассмотрите ручное управление позицией

2. **Ордера не размещаются**
   - Проверьте: Реальная позиция > 0 и существуют активные ветки
   - Проверьте: API учетные данные и разрешения
   - Мониторьте: 30-секундные интервалы проверки SELL

3. **Истечение TTL**
   - Симптом: `🔁 Переразмещаем BUY ближе к рынку`
   - Нормально: Автоматическое переразмещение ближе к bid
   - Мониторьте: Обеспечьте итоговое исполнение

### Оптимизация производительности

- **Частота тиков**: Настройте `TICK_SECONDS` для баланса отзывчивости и лимитов API
- **Длительность TTL**: Балансируйте `BUY_TTL_SECONDS` под рыночные условия
- **Размер позиций**: Настройте подходящие `BUY_QTY` для размера аккаунта

## 🔒 Соображения безопасности

- **API ключи**: Храните безопасно в `.env` файле, никогда не коммитьте в репозиторий
- **Разрешения**: Используйте API ключи только для торговли когда возможно
- **Мониторинг**: Регулярные проверки поведения бота и позиций
- **Управление рисками**: Устанавливайте подходящие размеры позиций и стоп-лоссы

## ⚠️ Предупреждение о рисках

- **Высокий риск**: Торговля криптовалютами включает существенный риск потерь
- **Автоматизированная торговля**: Решения бота могут не соответствовать рыночным условиям
- **Тестирование**: Всегда тестируйте сначала с небольшими суммами
- **Мониторинг**: Рекомендуется регулярный контроль
- **Никаких гарантий**: Прошлые результаты не гарантируют будущие результаты

## 🤝 Участие в проекте

1. Форкните репозиторий
2. Создайте ветку функции (`git checkout -b feature/amazing-feature`)
3. Закоммитьте изменения (`git commit -m 'Add amazing feature'`)
4. Отправьте в ветку (`git push origin feature/amazing-feature`)
5. Откройте Pull Request

## 📝 Лицензия

Этот проект предназначен только для образовательных целей. Используйте на свой страх и риск.

## 📞 Поддержка

- **Issues**: Создавайте GitHub Issues для багов и запросов функций
- **Обсуждения**: Используйте GitHub Discussions для вопросов
- **Документация**: Проверьте папку `docs/` для детальных руководств

---

**⚡ Создано на Python • 🚀 Работает на Starknet • 📈 Оптимизировано для X10**